<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LINEãƒˆãƒ¼ã‚¯è¦ç´„ï¼†è¿”ä¿¡ç”Ÿæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }

    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      padding: 12px;
      box-sizing: border-box;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.5);
      border: 1px solid #1f2937;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .help-toggle {
      font-size: 0.85rem;
      color: #60a5fa;
      text-decoration: underline;
      cursor: pointer;
    }

    .help-box {
      margin-top: 8px;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 12px;
      background: #0b1120;
      border: 1px solid #1f2937;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .help-box ol {
      padding-left: 1.1rem;
      margin: 4px 0;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .tone-select {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    .tone-option {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      cursor: pointer;
      user-select: none;
      background: #020617;
    }

    .tone-option input {
      accent-color: #60a5fa;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.9rem;
    }

    textarea::placeholder {
      color: #6b7280;
    }

    textarea:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px #60a5fa60;
    }

    .stats {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-left: auto;
    }

    button {
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 10px 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-sizing: border-box;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      flex: 1;
    }

    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      min-width: 110px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .result {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #1f2937;
    }

    .summary {
      font-size: 0.95rem;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }

    .replies {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .reply-btn {
      text-align: left;
      border-radius: 999px;
      padding: 10px 12px;
      background: #020617;
      border: 1px solid #374151;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: normal;
    }

    .reply-btn:hover {
      background: #111827;
    }

    .reply-btn.copied {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e60;
    }

    .status {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9ca3af;
      min-height: 1.2em;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 2px 8px;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* åˆå›ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #374151;
      padding: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.7);
      font-size: 0.9rem;
    }

    .modal h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }

    .modal ol {
      margin: 4px 0 8px;
      padding-left: 1.2rem;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 640px) {
      .card {
        padding: 12px;
      }
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      .stats {
        width: 100%;
        text-align: right;
      }
      .btn-primary {
        width: 100%;
      }
      .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- åˆå›èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="guideModal" class="modal-backdrop">
    <div class="modal">
      <h2>ã‹ã‚“ãŸã‚“3ã‚¹ãƒ†ãƒƒãƒ—</h2>
      <ol>
        <li>LINEã§ãƒˆãƒ¼ã‚¯ç”»é¢ã‚’é–‹ãã¾ã™ã€‚</li>
        <li>ç”»é¢ã‚’é•·æŠ¼ã—ã—ã¦ã€Œã™ã¹ã¦é¸æŠã€â†’ã€Œã‚³ãƒ”ãƒ¼ã€ã€‚</li>
        <li>ã“ã®ç”»é¢ã«ã‚‚ã©ã£ã¦ã€ä¸‹ã®ã€ŒğŸ“‹ è²¼ã‚Šä»˜ã‘ã€ã‚’æŠ¼ã—ã¦ã€Œç”Ÿæˆã€ã€‚</li>
      </ol>
      <p style="font-size:0.8rem;color:#9ca3af;">
        è¿”ä¿¡å€™è£œã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€æ–‡ç« ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ã€‚ã‚ã¨ã¯LINEã«è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ã™ã€‚
      </p>
      <div class="modal-buttons">
        <button id="modalOnceBtn" class="btn-secondary" type="button">
          æ¬¡ã‹ã‚‰è¡¨ç¤ºã—ãªã„
        </button>
        <button id="modalCloseBtn" class="btn-primary" type="button">
          ã¯ã˜ã‚ã‚‹
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1>LINEãƒˆãƒ¼ã‚¯è¦ç´„ï¼†è¿”ä¿¡ç”Ÿæˆ</h1>
      <div class="subtitle">
        ãƒˆãƒ¼ã‚¯ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒšã™ã‚‹ã¨ã€è¦ç´„ã¨è¿”ä¿¡å€™è£œ3ã¤ã‚’ä½œã‚Šã¾ã™ã€‚
        <span id="helpToggle" class="help-toggle">ä½¿ã„æ–¹ã‚’è¦‹ã‚‹</span>
      </div>

      <div id="helpBox" class="help-box" style="display:none;">
        <strong>LINEã‹ã‚‰ã®ä½¿ã„æ–¹</strong>
        <ol>
          <li>LINEã§ãƒˆãƒ¼ã‚¯ç”»é¢ã‚’é–‹ãã¾ã™ã€‚</li>
          <li>ç”»é¢ã‚’é•·æŠ¼ã— â†’ã€Œã™ã¹ã¦é¸æŠã€â†’ã€Œã‚³ãƒ”ãƒ¼ã€ã€‚</li>
          <li>ã“ã®ç”»é¢ã«ã‚‚ã©ã£ã¦ã€ŒğŸ“‹ è²¼ã‚Šä»˜ã‘ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
          <li>ãƒˆãƒ¼ãƒ³ï¼ˆstandard / night / businessï¼‰ã‚’é¸ã‚“ã§ã€Œè¦ç´„ï¼†è¿”ä¿¡ã‚’ç”Ÿæˆã€ã€‚</li>
          <li>è¿”ä¿¡å€™è£œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€LINEã«è²¼ã‚Šä»˜ã‘ã¦é€ã‚Šã¾ã™ã€‚</li>
        </ol>
      </div>

      <div class="row">
        <div class="tone-select">
          <span style="font-size:0.8rem;color:#9ca3af;">ãƒˆãƒ¼ãƒ³:</span>
          <label class="tone-option">
            <input type="radio" name="tone" value="standard" checked />
            <span>standard</span>
          </label>
          <label class="tone-option">
            <input type="radio" name="tone" value="night" />
            <span>nightï¼ˆå–¶æ¥­ï¼‰</span>
          </label>
          <label class="tone-option">
            <input type="radio" name="tone" value="business" />
            <span>business</span>
          </label>
        </div>
        <div class="stats">
          <span id="charCount">0</span> / 8000 æ–‡å­—
        </div>
      </div>

      <label for="inputText">â‘  LINEã®ãƒˆãƒ¼ã‚¯ã‚’ã“ã“ã«å…¥ã‚Œã‚‹</label>
      <textarea
        id="inputText"
        placeholder="LINEã®ãƒˆãƒ¼ã‚¯ç”»é¢ã‚’é•·æŠ¼ã— â†’ã€Œã™ã¹ã¦é¸æŠã€â†’ã€Œã‚³ãƒ”ãƒ¼ã€ã—ã¦ã€&#10;ä¸‹ã®ã€ŒğŸ“‹ è²¼ã‚Šä»˜ã‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã“ã“ã«å…¥ã‚Šã¾ã™ã€‚"
      ></textarea>

      <div class="row" style="margin-top:10px;">
        <button id="pasteBtn" class="btn-secondary" type="button">
          ğŸ“‹ è²¼ã‚Šä»˜ã‘
        </button>
        <button id="generateBtn" class="btn-primary" type="button">
          âœ¨ è¦ç´„ï¼†è¿”ä¿¡ã‚’ç”Ÿæˆ
        </button>
      </div>

      <div class="status" id="status"></div>

      <div class="badge" style="margin-top:4px;">
        <span class="badge-dot"></span>
        <span>ã“ã®ç”»é¢ã®ã¾ã¾ä½¿ãˆã¾ã™ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ï¼‰</span>
      </div>

      <div class="result" id="result" style="display:none;">
        <div class="summary">
          <strong>â‘¡ ä¼šè©±ã®è¦ç´„</strong><br />
          <span id="summaryText"></span>
        </div>
        <div class="replies">
          <strong style="font-size:0.9rem;">â‘¢ é€ã‚ŠãŸã„æ–‡ç« ã‚’é¸ã‚“ã§ã‚³ãƒ”ãƒ¼</strong>
          <button class="reply-btn" data-index="0"></button>
          <button class="reply-btn" data-index="1"></button>
          <button class="reply-btn" data-index="2"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const textarea = document.getElementById('inputText');
    const charCount = document.getElementById('charCount');
    const generateBtn = document.getElementById('generateBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const summaryText = document.getElementById('summaryText');
    const replyButtons = document.querySelectorAll('.reply-btn');
    const helpToggle = document.getElementById('helpToggle');
    const helpBox = document.getElementById('helpBox');
    const guideModal = document.getElementById('guideModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalOnceBtn = document.getElementById('modalOnceBtn');

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    textarea.addEventListener('input', () => {
      const len = textarea.value.length;
      charCount.textContent = len.toString();
    });

    function getTone() {
      const radios = document.querySelectorAll('input[name="tone"]');
      for (const r of radios) {
        if (r.checked) return r.value;
      }
      return 'standard';
    }

    // ä½¿ã„æ–¹ãƒˆã‚°ãƒ«
    helpToggle.addEventListener('click', () => {
      const visible = helpBox.style.display !== 'none';
      helpBox.style.display = visible ? 'none' : 'block';
      helpToggle.textContent = visible ? 'ä½¿ã„æ–¹ã‚’è¦‹ã‚‹' : 'ä½¿ã„æ–¹ã‚’é–‰ã˜ã‚‹';
    });

    // åˆå›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºåˆ¶å¾¡
    function openGuideModal() {
      guideModal.style.display = 'flex';
    }
    function closeGuideModal() {
      guideModal.style.display = 'none';
    }

    if (!localStorage.getItem('talkAssistGuideHidden')) {
      // åˆå›ã ã‘å°‘ã—é…ã‚‰ã›ã¦è¡¨ç¤º
      setTimeout(openGuideModal, 400);
    }

    modalCloseBtn.addEventListener('click', () => {
      closeGuideModal();
    });
    modalOnceBtn.addEventListener('click', () => {
      localStorage.setItem('talkAssistGuideHidden', '1');
      closeGuideModal();
    });

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘
    async function pasteFromClipboard() {
      try {
        const text = await navigator.clipboard.readText();
        if (!text) {
          statusEl.textContent = 'ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚LINEå´ã§ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          return;
        }
        textarea.value = text;
        charCount.textContent = text.length;
        statusEl.textContent = 'LINEã‹ã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'è‡ªå‹•è²¼ã‚Šä»˜ã‘ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é•·æŠ¼ã—ã—ã¦æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
      }
    }

    pasteBtn.addEventListener('click', () => {
      pasteFromClipboard();
    });

    async function callApi() {
      const text = textarea.value.trim();
      if (!text) {
        statusEl.textContent = 'ã¾ãšLINEã®ãƒˆãƒ¼ã‚¯ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
        return;
      }

      generateBtn.disabled = true;
      pasteBtn.disabled = true;
      statusEl.textContent = 'ç”Ÿæˆä¸­ã§ã™...ï¼ˆæ•°ç§’ã€œåæ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰';
      resultEl.style.display = 'none';

      const url = '/api/talk/assist';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text,
            tone: getTone(),
          }),
        });

        if (!res.ok) {
          const bodyText = await res.text();
          console.error('API error', res.status, bodyText);
          statusEl.textContent = `AIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${res.status}`;
          return;
        }

        const data = await res.json();
        summaryText.textContent = data.summary || '';

        const replies = data.replies || [];
        replyButtons.forEach((btn, idx) => {
          const t = replies[idx] || '';
          if (t) {
            btn.textContent = t;
            btn.disabled = false;
          } else {
            btn.textContent = `è¿”ä¿¡å€™è£œ${idx + 1}ï¼ˆæœªç”Ÿæˆï¼‰`;
            btn.disabled = true;
          }
          btn.classList.remove('copied');
        });

        resultEl.style.display = 'block';
        statusEl.textContent = 'è¿”ä¿¡å€™è£œã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ã€‚LINEã«è²¼ã‚Šä»˜ã‘ã¦é€ã£ã¦ãã ã•ã„ã€‚';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      } finally {
        generateBtn.disabled = false;
        pasteBtn.disabled = false;
      }
    }

    generateBtn.addEventListener('click', () => {
      callApi();
    });

    // è¿”ä¿¡ãƒœã‚¿ãƒ³ â†’ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
    replyButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const text = btn.textContent || '';
        if (!text || text.startsWith('è¿”ä¿¡å€™è£œ')) return;

        try {
          await navigator.clipboard.writeText(text);
          replyButtons.forEach((b) => b.classList.remove('copied'));
          btn.classList.add('copied');
          statusEl.textContent = 'è¿”ä¿¡æ¡ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–‡ç« ã‚’é•·æŠ¼ã—ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚';
        }
      });
    });
  </script>
</body>
</html>